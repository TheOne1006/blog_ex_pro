"use strict";angular.module("theoneAppAdmin",["ngAnimate","ngAria","ngCookies","ngMessages","ngResource","ui.router","ngGrid","ui.bootstrap","ui.tinymce","ui.codemirror","ngTagsInput","ngSanitize","ngTouch","angularFileUpload","theoneAppAdmin.services","theoneAppAdmin.filters","theoneAppAdmin.controllers","theoneAppAdmin.route"]),angular.module("theoneAppAdmin.services",["ngResource"]),angular.module("theoneAppAdmin.route",[]),angular.module("theoneAppAdmin.controllers",["theoneAppAdmin.services"]),angular.module("theoneAppAdmin.filters",[]),angular.module("theoneAppAdmin.services").directive("previewImg",["$window",function(a){var b={support:!(!a.FileReader||!a.CanvasRenderingContext2D),isFile:function(b){return angular.isObject(b)&&b instanceof a.File},isImage:function(a){var b="|"+a.type.slice(a.type.lastIndexOf("/")+1)+"|";return-1!=="|jpg|png|jpeg|bmp|gif|".indexOf(b)}};return{restrict:"A",scope:{mypreview:"="},template:"<canvas/>",link:function(a,c,d){function e(a){var b=new Image;b.onload=f,b.src=a.target.result}function f(){var a=i.width||this.width/this.height*i.height,b=i.height||this.height/this.width*i.width;h.attr({width:a,height:b}),j?h[0].getContext("2d").drawImage(this,0,0,a,b):h.attr({src:angular.element(this).attr("src")})}var g=new FileReader,h=c.find("canvas"),i=a.$eval(d.previewImg),j=!0;b.support||(j=!1),j||(c.empty().html("<img />"),h=c.find("img")),a.$watch("mypreview",function(){b.isFile(a.mypreview)&&b.isImage(a.mypreview)&&(g.onload=e,g.readAsDataURL(a.mypreview))})}}}]),angular.module("theoneAppAdmin.services").directive("fileChange",["$parse",function(a){return{restrict:"A",link:function(b,c,d){var e=a(d.fileChange),f=function(a){b.$apply(function(){e(b,{$event:a,files:a.target.files})})};c[0].addEventListener("change",f,!1)}}}]),angular.module("theoneAppAdmin.route").config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/"),a.state("main",{"abstract":!0,url:"",views:{lefter:{templateUrl:"/angular/views/admin/lefter.main.html"}}}).state("main.home",{url:"/",views:{"@":{templateUrl:"/angular/views/admin/main.html"}}}).state("main.cate",{url:"/cate",views:{"@":{templateUrl:"/angular/views/admin/cate.html",controller:"CateController"}}}).state("main.article",{url:"/article",views:{"@":{templateUrl:"/angular/views/admin/article.list.html",controller:"ArticleController"}}}).state("main.article.add",{url:"/add",views:{"@":{templateUrl:"/angular/views/admin/article.add.html",controller:"ArticleAddController"}}}).state("main.article.edit",{url:"/edit/:id",views:{"@":{templateUrl:"/angular/views/admin/article.edit.html",controller:"ArticleEditController"}}}).state("main.tag",{url:"/tag",views:{"@":{templateUrl:"/angular/views/admin/tag.list.html",controller:"TagListController"}}}).state("main.carousel",{url:"/carousel",views:{"@":{templateUrl:"/angular/views/admin/carousel.list.html",controller:"CarouselCtrl"}}}).state("main.pictures",{url:"/pictures",views:{"@":{templateUrl:"/angular/views/admin/pictures.list.html",controller:"PicturesList"}}}).state("user",{"abstract":!0,url:"/user",views:{lefter:{templateUrl:"/angular/views/admin/lefter.user.html"}}}).state("user.index",{url:"",views:{"@":{templateUrl:"/angular/views/admin/user/main.html"}}}).state("user.photo",{url:"/photo",views:{"@":{templateUrl:"/angular/views/admin/user/user.photo.html",controller:"UserPhotoController"}}})}]),angular.module("theoneAppAdmin.controllers").controller("ArticleAddController",["$scope","tinymceService","articleService","catesService",function(a,b,c,d){function e(){a.keyWords=[],a.newArticle={title:"",cate:"",keyWords:[],contentHtml:"",contentMd:"",content:"",type:"html"}}a.tableName="添加文章",a.keyWords=[],e(),d.list().then(function(b){a.cates=b}),a.editorOptions={lineWrapping:!0,lineNumbers:!0,matchBrackets:!0,mode:"gfm",theme:"base16-light"},a.save=function(){c.create(a.newArticle,a.keyWords).then(function(a){console.log("success"),console.log(a),e()},function(a){console.log("fail"),console.log(a)})},a.tinymceOptions=b.options}]),angular.module("theoneAppAdmin.controllers").controller("ArticleEditController",["$scope","$stateParams","adminModalService","tinymceService","UiTool","catesService","articleService",function(a,b,c,d,e,f,g){var h;a.tableName="编辑文章",a.article={},f.list().then(function(b){a.cates=b}),g.get(b.id).then(function(b){"html"===b.type?b.contentHtml=b.content:b.contentMd=b.content,a.article=b,h=b,a.needRefresh=1}),a.tinymceOptions=d.options,a.editorOptions={lineWrapping:!0,lineNumbers:!0,matchBrackets:!0,mode:"gfm",theme:"base16-light"},a.save=function(){g.save(a.article).then(function(a){console.log(a)})}}]),angular.module("theoneAppAdmin.controllers").controller("DelArticleController",["$scope","$modalInstance","adminModalService","articleService",function(a,b,c,d){var e=c.current();d.get(e).then(function(b){a.article=b}),a.confirm=function(){d.del(e).then(function(a){console.log(a),b.close()})},a.cancel=function(){b.dismiss()}}]),angular.module("theoneAppAdmin.controllers").controller("ArticleController",["$scope","$http","$filter","$timeout","adminModalService","articlesService",function(a,b,c,d,e,f){var g="";a.tableName="文章列表",a.anywords=[],a.anywords=["PHP","angular","javascript","mysql"],a.filterOptions={filterText:"",useExternalFilter:!0},a.pagingOptions={pageSizes:[10],pageSize:10,currentPage:1},a.setPagingData=function(b,c,d){var e=b;a.myData=e,a.totalServerItems=b.length,a.$$phase||a.$apply()},a.getPagedDataAsync=function(b,c,d){d&&angular.isString(d)&&(d=d.toLowerCase());var e={page:c,limit:b,keyword:d};f.list(e).$promise.then(function(d){a.setPagingData(d,c,b)})},a.getPagedDataAsync(a.pagingOptions.pageSize,a.pagingOptions.currentPage),a.$watch("pagingOptions",function(b,c){b!==c&&b.currentPage!==c.currentPage&&a.getPagedDataAsync(a.pagingOptions.pageSize,a.pagingOptions.currentPage,a.filterOptions.filterText)},!0),a.$watch("goany",function(b,c){"string"==typeof b&&(b=b.toLowerCase()),"string"==typeof c&&(c=c.toLowerCase()),b!==c&&(g&&d.cancel(g),g=d(function(){a.filterOptions.filterText=b,a.pagingOptions.currentPage=1,a.getPagedDataAsync(a.pagingOptions.pageSize,a.pagingOptions.currentPage,a.filterOptions.filterText)},500))},!1),a.filterOptions={name:""},a.gridOptions={data:"myData",columnDefs:[{field:"_id",displayName:"ID",width:60,pinnable:!1,sortable:!1,cellTemplate:'<div class="ngCellText" ng-class="col.colIndex()"><span>{{row.rowIndex+1}}</span></div>'},{field:"title",displayName:"标题"},{field:"keyWords",displayName:"关键词"},{field:"updateTime",displayName:"更新时间",cellFilter:'date:"yyyy-MM-dd"'},{displayName:"操作",cellTemplate:'<div class="ngCellText"><a ng-href="#/article/edit/{{row.entity._id}}">编辑</a> &nbsp; <a href="javascript:;" ng-click="delOpen(row.entity._id)">删除</a></div>'}],showGroupPanel:!1,showFooter:!0,enablePaging:!0,enableRowSelection:!0,multiSelect:!1,pagingOptions:a.pagingOptions,filterOptions:a.filterOptions},a.delOpen=function(a){e.modalOpen({templateUrl:"/angular/views/modal/article.del.html",controller:"DelArticleController",backdropClass:"heightfull"},a)}}]),angular.module("theoneAppAdmin.controllers").controller("AddCateController",["$scope","$modalInstance","cateService","catesService",function(a,b,c,d){a.cate={name:"",alias:"",pid:""},d.list().then(function(b){a.parentCates=b}),a.save=function(){c.create(a.cate).then(function(a){console.log(a),b.close()},function(a){b.close()})},a.cancel=function(){console.log("close"),b.dismiss()}}]),angular.module("theoneAppAdmin.controllers").controller("EditCateController",["$scope","$modalInstance","adminModalService","cateService","articlesService",function(a,b,c,d,e){var f=c.current();a.cate={},d.get(f).then(function(b){a.cate=b}),e.listByCate(f).then(function(b){a.articles=b}),a.toggleSelection=function(b){var c=a.cate.topArticles.indexOf(b);c>-1?a.cate.topArticles.splice(c,1):a.cate.topArticles.push(b)},a.save=function(){d.save(a.cate).then(function(a){b.close()})},a.cancel=function(){b.dismiss()}}]),angular.module("theoneAppAdmin.controllers").controller("DelCateController",["$scope","$modalInstance","adminModalService","cateService",function(a,b,c,d){var e=c.current();a.cate={},d.get(e).then(function(b){a.cate=b}),a.confirm=function(){d.del(e).then(function(a){console.log(a),b.close()})},a.cancel=function(){b.dismiss()}}]),angular.module("theoneAppAdmin.controllers").controller("CateController",["$scope","$http","$modal","adminModalService","catesService",function(a,b,c,d,e){a.tableName="类别表",a.filterOptions={filterText:"",useExternalFilter:!0},a.totalServerItems=0,a.pagingOptions={pageSizes:[5,10,20],pageSize:10,currentPage:1},a.setPagingData=function(b,c,d){a.myData=b,a.totalServerItems=b.length,a.$$phase||a.$apply()},a.getPagedDataAsync=function(b,c,d){d&&angular.isString(d)&&(d=d.toLowerCase());var f={page:c,limit:b,keyword:d};e.list(f).then(function(d){a.setPagingData(d,c,b)})},a.getPagedDataAsync(a.pagingOptions.pageSize,a.pagingOptions.currentPage),a.$watch("pagingOptions",function(b,c){b!==c&&b.currentPage!==c.currentPage&&a.getPagedDataAsync(a.pagingOptions.pageSize,a.pagingOptions.currentPage,a.filterOptions.filterText)},!0),a.gridOptions={data:"myData",columnDefs:[{displayName:"ID",width:60,pinnable:!1,sortable:!1,cellTemplate:'<div class="ngCellText" ng-class="col.colIndex()"><span>{{row.rowIndex+1}}</span></div>'},{field:"name",displayName:"名称"},{field:"articleNum",displayName:"文章数量"},{field:"updateTime",displayName:"更新时间",cellFilter:'date:"yyyy-MM-dd"'},{field:"_id",displayName:"操作",cellTemplate:'<div class="ngCellText" ng-class="col.colIndex()"><span ng-cell-text><a href="javascript:;" ng-click="editOpen(row.entity._id)" >操作</a>&nbsp;<a href="javascript:;" cateid={{row["entity"]["_id"]}} ng-click="delOpen(row.entity._id)" >删除</a></span></div>'}],showGroupPanel:!1,showFooter:!0,enablePaging:!0,enableRowSelection:!0,multiSelect:!1,pagingOptions:a.pagingOptions,filterOptions:a.filterOptions},a.open=function(a){d.modalOpen({templateUrl:"/angular/views/modal/cate.add.html",size:a,controller:"AddCateController",backdropClass:"heightfull"})},a.delOpen=function(a){d.modalOpen({templateUrl:"/angular/views/modal/cate.del.html",controller:"DelCateController",backdropClass:"heightfull"},a)},a.editOpen=function(a){d.modalOpen({templateUrl:"/angular/views/modal/cate.edit.html",controller:"EditCateController",size:"large",backdropClass:"heightfull"},a)}}]),angular.module("theoneAppAdmin.controllers").controller("CarouselCtrl",["$scope","$http","adminModalService",function(a,b,c){function d(){b.get("/admin/carousel/list").success(function(b){a.carouselList=b})}a.h1Title="首页Carsouel设置",a.tableName="首页幻灯片列表",a.carouselList=[],a.open=function(a){c.modalOpen({templateUrl:"/angular/views/modal/carousel.add.html",size:a,controller:"AddCarouselCtrl",backdropClass:"heightfull"})},a.uploadCloud=function(a){b.get("/admin/carousel/upClould/"+a).success(function(a){d()})},a.delCloud=function(a){b.get("/admin/carousel/delClould/"+a).success(function(a){d()})},a.changeStatus=function(a){b.get("/admin/carousel/changStatus/"+a).success(function(a){d()})},a.singleRemove=function(a){b["delete"]("/admin/carousel/del/"+a).success(function(a){d()})},d()}]),angular.module("theoneAppAdmin.controllers").controller("AddCarouselCtrl",["$scope","$modalInstance","FileUploader",function(a,b,c){a.position=1,a.imgTitle="",a.imgDesc="";var d=a.uploader=new c({url:"/admin/carousel/add",method:"put",alias:"carousel",queueLimit:2});d.filters.push({name:"onlyOne",fn:function(){var a=d.queue.length;return a&&d.clearQueue(),!0}}),d.onAfterAddingFile=function(b){a.mypreview=b._file},a.$watch("position",function(){d.formData[0]={position:a.position}}),a.$watch("imgTitle",function(){d.formData[1]={imgTitle:a.imgTitle}}),a.$watch("imgDesc",function(){d.formData[2]={imgDesc:a.imgDesc}}),a.upload=function(){console.log("before"),d.uploadItem(0),b.close()},a.cancel=function(){b.dismiss()}}]),angular.module("theoneAppAdmin.controllers").controller("AddPictureCtrl",["$scope","$modalInstance","FileUploader",function(a,b,c){a.kind="article",a.imgtitle="pic";var d=[{kind:a.kind,imgTitle:a.imgtitle}],e=a.uploader=new c({url:"/admin/picture/add",method:"put",alias:"picture",formData:d});a.upload=function(){e.queue[0].formData=[{kind:a.kind,imgTitle:a.imgtitle}],console.log(e),e.uploadAll(),b.close()},a.cancel=function(){b.dismiss()},e.onAfterAddingFile=function(b){a.mypreview=b._file}}]),angular.module("theoneAppAdmin.controllers").controller("PicturesList",["$scope","adminModalService","PictureService",function(a,b,c){a.h1Title="图片管理",a.pictures=[],c.list(function(b){console.log(b),a.pictures=b}),a.open=function(a){b.modalOpen({templateUrl:"/angular/views/modal/picture.add.html",size:a,controller:"AddPictureCtrl",backdropClass:"heightfull"})},a.uploadCloud=function(a){c.upClould(a,function(a){console.log(a)})},a.delCloud=function(a){c.delClould(a,function(a){console.log(a)})}}]),angular.module("theoneAppAdmin.controllers").controller("UserController",["$scope",function(a){a.name=""}]),angular.module("theoneAppAdmin.controllers").controller("UserPhotoController",["$scope","$http","userPhotoService",function(a,b,c){a.photos=[],a.user="",a.facePpPower={create:!1,update:!1},c.getMyPhotos().success(function(b){a.photos=b}),c.getUserInfo().success(function(c){a.user=c,c.facePersonId?a.facePpPower.update=!0:b.get("/admin/user/createFacePower").success(function(b){b&&b.hasCreatePower&&(a.facePpPower.create=b.hasCreatePower)})}),a.takePhoto=function(){c.modalOpen({templateUrl:"/angular/views/modal/user.photo.add.html",size:"lg",controller:"UserPhotoAddController",backdropClass:"heightfull"})},a.uploader={cloud:function(a){console.log("111"),c.upload2Cloud("/admin/user/up2cloud",a).success(function(a){console.log(a)})},facePP:function(a){c.upload2Cloud("/admin/user/up2facePP",a).success(function(a){console.log(a)})},createPerson:function(){return a.facePpPower.create?void c.createPerson().success(function(a){console.log(a)}):!1},updatePerson:function(){return a.facePpPower.update?void c.updatePerson().success(function(a){console.log(a)}):!1}},a.deleter={cloud:function(a){c.delete4Cloud("/admin/user/cloudSingle/"+a)},facePP:function(a){c.delete4FacePP("/admin/user/faceSingle/"+a)}}}]),angular.module("theoneAppAdmin.controllers").controller("UserPhotoAddController",["$scope","$http","$modalInstance","$window",function(a,b,c,d){var e=d.Webcam;a.photoList=[],e&&e.set({width:360,height:280,image_format:"jpeg",jpeg_quality:90}),a.begin=function(){e.attach("#modalMovie")},a.cancel=function(){e.container&&e.reset(),c.dismiss()},a.delphoto=function(b){a.photoList.splice(b,1)},a.ok=function(){e.container&&e.snap(function(b){a.photoList.push(b)})},a.upload=function(){a.photoList&&b.post("/admin/user/addUserPhotos",{photos:a.photoList}).success(function(a){console.log(a)})}}]),angular.module("theoneAppAdmin.controllers").controller("TagListController",["$scope","adminModalService",function(a,b){a.tableName="标签列表",a.tags=[],b.getlist("/admin/tag/list").success(function(b){a.tags=b})}]),angular.module("theoneAppAdmin.services").factory("PictureService",["$resource",function(a){var b=a("/admin/pictures"),c=a("/admin/picture/clould/:id",null,{upload:{method:"get",isArray:!1,url:"/admin/picture/upClould/:id"},delClould:{method:"delete",isArray:!1,url:"/admin/picture/upClould/:id"},timeout:2e4}),d=function(a){return b.query({},function(b){a&&a(b)}).$promise},e=function(a,b){return c.upload({id:a},function(a){b&&b(a)}).$promise},f=function(a,b){return c.delClould({id:a},function(a){b&&b(a)}).$promise};return{list:function(a){return d(a)},upClould:function(a,b){return e(a,b)},delClould:function(a,b){return f(a,b)}}}]),angular.module("theoneAppAdmin.services").factory("adminModalService",["$http","$modal",function(a,b){var c="",d=function(a){var c=b.open(a);c.result.then(function(a){console.log(a)})},e=function(b){return a["delete"](b)},f=function(b,c){return a.put(b,c)},g=function(b){return a.get(b)},h=function(b,c){return a.post(b,c)};return{current:function(){return c},cateList:function(a){return g(a)},modalOpen:function(a,b){return c="",b&&(c=b),d(a)},getId:function(a){return g(a)},delId:function(a){return e(a)},putNew:function(a,b){return f(a,b)},getlist:function(a){return g(a)},postlist:function(a,b){return h(a,b)},doEdit:function(a,b){return h(a,b)}}}]),angular.module("theoneAppAdmin.services").factory("UiTool",[function(){return{tagInput2arr:function(a,b){var c=[];return angular.isArray(a)?(a.length>0&&angular.forEach(a,function(a){c.push(a.text)}),angular.isString(b)?c.join():angular.isArray(b)?c:c):!1}}}]),angular.module("theoneAppAdmin.services").factory("tinymceService",[function(){return{options:{menubar:!0,theme:"modern",plugins:"pagebreak,link,table,save,insertdatetime,preview,media,searchreplace,contextmenu,paste,directionality,noneditable,visualchars,nonbreaking,template,code,hr,prettify,tabset,image",toolbar:"insertfile undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image | prettify | tabset | hr",content_css:"/public/css/admin/tinymceCommon.css",extended_valid_elements:"tab[heading],tabset[justified]",custom_elements:"tab,tabset",language:"zh_CN"}}}]),angular.module("theoneAppAdmin.services").factory("userPhotoService",["$http","$modal",function(a,b){var c=function(b){return a.get(b)},d=function(b,c){return a["delete"](b,c)},e=function(a){var c=b.open(a);c.result.then(function(a){console.log(a)})};return{modalOpen:function(a){return e(a)},getMyPhotos:function(){return c("/admin/user/myPhotoList")},upload2Cloud:function(a,b){return c(a+"/"+b)},getUserInfo:function(){return c("/admin/user/myInfo")},createPerson:function(){return c("/admin/user/createFacePerson")},updatePerson:function(){return c("/admin/user/updateFacePerson")},delete4Cloud:function(a,b){return d(a,b)},delete4FacePP:function(a,b){return d(a,b)}}}]),angular.module("theoneAppAdmin.services").factory("tagsService",["$resource",function(a){var b=a("/admin/api/tags",{});return{allList:function(){return b.query()}}}]),angular.module("theoneAppAdmin.services").factory("articleService",["$resource","$q","UiTool",function(a,b,c){var d={title:"",cate:"",keyWords:[],contentHtml:"",contentMd:"",content:"",type:"html"},e=a("/admin/api/article/:id",{id:"@id"},{create:{method:"PUT"}});return{create:function(a,f){var g=angular.extend({},d,a),h=b.defer();return g.content="html"===g.type?g.contentHtml:g.contentMd,g.cate&&g.cate._id&&(g.cate=g.cate._id),g.keyWords=c.tagInput2arr(f,[]),e.create({article:g},function(a){h.resolve(a)},function(a){h.reject(a)}),h.promise},save:function(a){return a.cate&&a.cate._id&&(a.cate=a.cate._id),a.content="html"===a.type?a.contentHtml:a.contentMd,a.keyWords=c.tagInput2arr(a.keyWords,[]),a.author&&a.author._id&&(a.author=a.author._id),e.save({id:a._id,article:a}).$promise},get:function(a){return e.get({id:a}).$promise},del:function(a){return e["delete"]({id:a}).$promise}}}]),angular.module("theoneAppAdmin.services").factory("articlesService",["$resource",function(a){var b=a("/admin/api/articles",{page:1,limit:10,keyword:"@keyword",cate:"@cateId"});return{list:function(a){return b.query(a)},listByCate:function(a){return b.query({cate:a,limit:100}).$promise}}}]),angular.module("theoneAppAdmin.services").factory("catesService",["$resource",function(a){var b=a("/admin/api/cates",{page:1,limit:10,keyword:"@keyword"});return{list:function(a){return b.query(a).$promise}}}]),angular.module("theoneAppAdmin.services").factory("cateService",["$resource",function(a){var b={name:"",alias:"",pid:""},c=a("/admin/api/cate/:id",{id:"@id"},{create:{method:"PUT"}});return{create:function(a){var d=angular.extend({},b,a);return d.pid&&d.pid._id&&(d.pid=d.pid._id),c.create({cate:d}).$promise},del:function(a){return c["delete"]({id:a}).$promise},get:function(a){return c.get({id:a}).$promise},save:function(a){var d=angular.extend({},b,a);return c.save({id:a._id,cate:d}).$promise}}}]),angular.module("theoneAppAdmin.filters").filter("getSingleFiled",function(){return function(a,b){var c=[],d=a.length;return d&&0!==d?(angular.forEach(a,function(a){a[b]&&(c[c.length]=a[b])}),c):c}});